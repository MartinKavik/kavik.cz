---
import { type CollectionEntry, getCollection, render } from 'astro:content';

import ContactCTA from '../../components/ContactCTA.astro';
import Hero from '../../components/Hero.astro';
import Icon from '../../components/Icon.astro';
import Pill from '../../components/Pill.astro';
import BaseLayout from '../../layouts/BaseLayout.astro';

interface Props {
	entry: CollectionEntry<'posts'>;
	prevPost: CollectionEntry<'posts'> | null;
	nextPost: CollectionEntry<'posts'> | null;
}

export async function getStaticPaths() {
	const posts = await getCollection('posts');
	// Sort by sortOrder (lower = newer/first)
	const sortedPosts = posts.sort((a, b) => (a.data.sortOrder ?? 0) - (b.data.sortOrder ?? 0));

	return sortedPosts.map((entry, index) => ({
		params: { slug: entry.id },
		props: {
			entry,
			// Previous = older post (higher sortOrder), Next = newer post (lower sortOrder)
			prevPost: index < sortedPosts.length - 1 ? sortedPosts[index + 1] : null,
			nextPost: index > 0 ? sortedPosts[index - 1] : null,
		},
	}));
}

const { entry, prevPost, nextPost } = Astro.props;
const { Content } = await render(entry);
---

<BaseLayout title={entry.data.title} description={entry.data.description}>
	<div class="stack gap-20">
		<div class="stack gap-15 page-content">
			<div class="deco-bricks" aria-hidden="true">
				<div class="deco-brick b1"></div>
				<div class="deco-brick b2"></div>
			</div>
			<header>
				<div class="wrapper stack gap-2">
					<a class="back-link" href="/blog/"><Icon icon="arrow-left" /> Blog</a>
					<Hero title={entry.data.title} align="start">
						<div class="details">
							{entry.data.tags.length > 0 && (
								<div class="tags">
									{entry.data.tags.map((t) => <Pill>{t}</Pill>)}
								</div>
							)}
							<p class="description">{entry.data.description}</p>
						</div>
					</Hero>
				</div>
			</header>
			<main class="wrapper blog-wrapper">
				<div class="stack gap-10 content">
					{entry.data.img && <img src={entry.data.img} alt={entry.data.img_alt || ''} />}
					<div class="content">
						<Content />
					</div>
				</div>
			</main>
			{(prevPost || nextPost) && (
				<nav class="post-navigation wrapper">
					<div class="nav-link prev">
						{prevPost && (
							<a href={`/blog/${prevPost.id}/`}>
								<span class="nav-label"><Icon icon="arrow-left" /> Previous</span>
								<span class="nav-title">{prevPost.data.title}</span>
							</a>
						)}
					</div>
					<div class="nav-link next">
						{nextPost && (
							<a href={`/blog/${nextPost.id}/`}>
								<span class="nav-label">Next <Icon icon="arrow-right" /></span>
								<span class="nav-title">{nextPost.data.title}</span>
							</a>
						)}
					</div>
				</nav>
			)}
		</div>
		<ContactCTA />
	</div>

	<!-- Lightbox -->
	<div class="blog-lightbox" id="blog-lightbox">
		<button class="blog-lightbox-close" aria-label="Close">&times;</button>
		<img id="blog-lightbox-img" src="" alt="" />
	</div>
</BaseLayout>

<style>
	.page-content {
		position: relative;
		overflow-x: hidden;
	}

	.blog-wrapper {
		overflow-x: hidden;
	}

	.deco-bricks {
		position: absolute;
		inset: 0;
		pointer-events: none;
		z-index: -1;
	}

	.deco-brick {
		position: absolute;
		opacity: 0.15;
	}

	.b1 {
		background: #2a9d8f;
		width: 55px;
		height: 40px;
		left: 1%;
		top: 0;
	}

	.b2 {
		background: #f72585;
		width: 40px;
		height: 50px;
		right: 2%;
		top: 1.5rem;
	}

	@media (min-width: 50em) {
		.b1 {
			width: 85px;
			height: 55px;
		}

		.b2 {
			width: 60px;
			height: 70px;
		}
	}

	header {
		padding-bottom: 2.5rem;
		border-bottom: 1px solid var(--gray-800);
	}

	.back-link {
		display: none;
	}

	.details {
		display: flex;
		flex-direction: column;
		padding: 0.5rem;
		gap: 1rem;
		justify-content: space-between;
		align-items: center;
	}

	.tags {
		display: flex;
		gap: 0.5rem;
		flex-wrap: wrap;
	}

	.description {
		font-size: var(--text-lg);
		max-width: 54ch;
	}

	.content {
		max-width: 65ch;
		width: 100%;
		margin-inline: auto;
		font-size: var(--text-md);
		line-height: 1.7;
		overflow-wrap: break-word;
		word-wrap: break-word;
		overflow-x: hidden;
	}

	.content > :global(* + *) {
		margin-top: 1rem;
	}

	@media (min-width: 50em) {
		.content {
			font-size: var(--text-lg);
		}
	}

	.content :global(h2) {
		margin-top: 4.5rem;
		margin-bottom: 1.25rem;
	}

	.content :global(h3) {
		margin-top: 3rem;
		margin-bottom: 0.75rem;
	}

	.content :global(h1),
	.content :global(h4),
	.content :global(h5) {
		margin: 1.5rem 0;
	}

	.content :global(img) {
		display: block;
		margin-inline: auto;
		max-width: 100%;
		height: auto;
		border-radius: 0.5rem;
		box-shadow: var(--shadow-sm);
		background: var(--gradient-subtle);
		border: 1px solid var(--gray-800);
	}

	:global(.theme-dark) .content :global(img[src*="shapeup"]) {
		filter: invert(0.7);
	}

	
	.content :global(p:has(img)) {
		text-align: center;
		margin-top: 2rem;
		margin-bottom: 3rem;
	}

	.content :global(p:has(img) + p > em:only-child),
	.content :global(p:has(img) > em:last-child) {
		display: block;
		text-align: center;
		font-size: var(--text-md);
		color: var(--gray-400);
		margin-top: 0.5rem;
		margin-bottom: 3rem;
	}

	.content :global(pre) {
		max-width: min(63ch, 100%);
		margin-inline: auto;
		margin-top: 1.5rem;
		margin-bottom: 3rem;
		padding: 1rem 1.5rem;
		border-radius: 0.75rem;
		border: 1px solid var(--gray-800);
		font-size: var(--text-md);
		overflow-x: auto;
	}

	.content :global(pre + p:has(> em:only-child)) {
		margin-top: -2rem;
		margin-bottom: 3rem;
	}

	.content :global(pre + p > em:only-child) {
		display: block;
		text-align: center;
		font-size: var(--text-md);
		color: var(--gray-400);
	}

	.content :global(blockquote) {
		font-size: var(--text-lg);
		font-family: var(--font-brand);
		font-weight: 600;
		line-height: 1.3;
		padding-inline-start: 1.5rem;
		border-inline-start: 0.25rem solid var(--accent-dark);
		color: var(--gray-0);
		margin-top: 1.5rem;
		margin-bottom: 3rem;
	}

	.content :global(.note) {
		display: flex;
		gap: 1rem;
		font-size: var(--text-md);
		line-height: 1.65;
		padding: 1rem 1.25rem;
		border-inline-start: 0.25rem solid var(--gray-600);
		background: var(--gray-999);
		border-radius: 0 0.5rem 0.5rem 0;
		color: var(--gray-300);
		margin-top: 1.5rem;
		margin-bottom: 3rem;
	}

	.content :global(.note svg) {
		flex-shrink: 0;
		color: var(--gray-400);
	}

	.content :global(.note p) {
		margin: 0;
	}

	.content :global(.note code) {
		color: var(--gray-200);
	}

	/* Tables */
	.content :global(table) {
		width: 100%;
		border-collapse: collapse;
		margin-top: 1.5rem;
		margin-bottom: 2.5rem;
		font-size: var(--text-base);
		border-radius: 0.75rem;
		overflow: hidden;
		border: 1px solid var(--gray-800);
	}

	.content :global(th),
	.content :global(td) {
		padding: 0.75rem 1rem;
		text-align: left;
		border-bottom: 1px solid var(--gray-800);
	}

	.content :global(th) {
		background: var(--gray-900);
		font-weight: 600;
		font-size: var(--text-sm);
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: var(--gray-300);
	}

	.content :global(td) {
		background: var(--gray-999);
	}

	.content :global(tr:last-child td) {
		border-bottom: none;
	}

	.content :global(tr:hover td) {
		background: var(--gray-900);
	}

	.content :global(td:not(:first-child)),
	.content :global(th:not(:first-child)) {
		text-align: right;
	}

	.content :global(td code) {
		font-size: var(--text-sm);
	}

	/* Lists */
	.content :global(ul),
	.content :global(ol) {
		margin: 1.5rem 0;
		padding-left: 0;
	}

	.content :global(ul) {
		list-style: none;
	}

	.content :global(ol) {
		list-style: none;
		counter-reset: item;
	}

	.content :global(li) {
		position: relative;
		padding-left: 1.5rem;
		margin: 0.75rem 0;
	}

	.content :global(ul li)::before {
		content: "â– ";
		position: absolute;
		left: 0;
		color: var(--accent-regular);
		font-size: 0.6em;
		line-height: 2.8;
	}

	.content :global(ol li) {
		counter-increment: item;
	}

	.content :global(ol li)::before {
		content: counter(item) ".";
		position: absolute;
		left: 0;
		color: var(--accent-regular);
		font-weight: 600;
	}

	.content :global(li strong) {
		color: var(--gray-100);
	}

	.back-link,
	.content :global(a) {
		text-decoration: 1px solid underline transparent;
		text-underline-offset: 0.25em;
		transition: text-decoration-color var(--theme-transition);
	}

	.back-link:hover,
	.back-link:focus,
	.content :global(a:hover),
	.content :global(a:focus) {
		text-decoration-color: currentColor;
	}

	@media (min-width: 50em) {
		.back-link {
			display: block;
			align-self: flex-start;
		}

		.details {
			flex-direction: row;
			gap: 2.5rem;
		}

		.content :global(blockquote) {
			font-size: var(--text-2xl);
		}
	}

	/* Post Navigation */
	.post-navigation {
		display: flex;
		flex-direction: column;
		gap: 1rem;
		padding-top: 3rem;
		margin-top: 3rem;
		border-top: 1px solid var(--gray-800);
	}

	.nav-link {
		flex: 1;
	}

	.nav-link a {
		display: flex;
		flex-direction: column;
		gap: 0.25rem;
		padding: 1rem 1.25rem;
		border-radius: 0.75rem;
		background: var(--gradient-subtle);
		border: 1px solid var(--gray-800);
		text-decoration: none;
		transition: border-color var(--theme-transition), box-shadow var(--theme-transition);
	}

	.nav-link a:hover {
		border-color: var(--gray-700);
		box-shadow: var(--shadow-sm);
	}

	.nav-link.prev a {
		align-items: flex-start;
	}

	.nav-link.next a {
		align-items: flex-end;
		text-align: right;
	}

	.nav-label {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		font-size: var(--text-sm);
		color: var(--gray-300);
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.nav-title {
		font-size: var(--text-lg);
		font-weight: 600;
		color: var(--gray-0);
		line-height: 1.3;
	}

	.nav-link a :global(svg) {
		color: var(--gray-400);
		transition: color var(--theme-transition);
	}

	.nav-link a:hover :global(svg) {
		color: var(--accent-regular);
	}

	@media (min-width: 50em) {
		.post-navigation {
			flex-direction: row;
			gap: 2rem;
		}

		.nav-title {
			font-size: var(--text-xl);
		}
	}

	/* Lightbox */
	.blog-lightbox {
		position: fixed;
		inset: 0;
		background: rgba(0, 0, 0, 0.95);
		display: flex;
		align-items: center;
		justify-content: center;
		z-index: 10000;
		opacity: 0;
		visibility: hidden;
		transition: opacity 0.3s ease, visibility 0.3s ease;
		cursor: zoom-out;
	}

	.blog-lightbox.active {
		opacity: 1;
		visibility: visible;
	}

	.blog-lightbox img {
		max-width: 90vw;
		max-height: 90vh;
		object-fit: contain;
		border-radius: 0.5rem;
	}

	.blog-lightbox-close {
		position: absolute;
		top: 1rem;
		right: 1rem;
		width: 44px;
		height: 44px;
		background: transparent;
		border: none;
		color: white;
		font-size: 2rem;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		opacity: 0.7;
		transition: opacity 0.2s ease;
		z-index: 10001;
	}

	.blog-lightbox-close:hover {
		opacity: 1;
	}

	.content :global(img) {
		cursor: zoom-in;
	}

	.content :global(.blog-expand-btn) {
		position: absolute;
		top: 0;
		right: 0;
		width: 36px;
		height: 36px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: var(--gray-900);
		border: 1px solid var(--gray-700);
		border-radius: 0.5rem;
		color: var(--gray-300);
		cursor: pointer;
		opacity: 0.7;
		transition: opacity 0.2s, background 0.2s, color 0.2s;
	}

	.content :global(.blog-expand-btn:hover) {
		opacity: 1;
		background: var(--gray-800);
		color: var(--gray-0);
	}
</style>

<script is:inline>
	(function() {
		function initBlogLightbox() {
			const lightbox = document.getElementById('blog-lightbox');
			const lightboxImg = document.getElementById('blog-lightbox-img');
			const closeBtn = document.querySelector('.blog-lightbox-close');
			const contentImages = document.querySelectorAll('.content img');

			if (!lightbox || !lightboxImg) return;

			const expandIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<polyline points="15 3 21 3 21 9"></polyline>
				<polyline points="9 21 3 21 3 15"></polyline>
				<line x1="21" y1="3" x2="14" y2="10"></line>
				<line x1="3" y1="21" x2="10" y2="14"></line>
			</svg>`;

			function openLightbox(imgSrc, imgAlt) {
				lightboxImg.src = imgSrc;
				lightboxImg.alt = imgAlt;
				// Apply invert filter for Shape Up image in dark mode
				if (imgSrc.includes('shapeup') && document.documentElement.classList.contains('theme-dark')) {
					lightboxImg.style.filter = 'invert(0.7)';
				} else {
					lightboxImg.style.filter = '';
				}
				lightbox.classList.add('active');
				document.body.style.overflow = 'hidden';
			}

			function closeLightbox() {
				lightbox.classList.remove('active');
				document.body.style.overflow = '';
			}

			contentImages.forEach((img) => {
				if (img.parentElement?.classList.contains('blog-img-wrapper')) return;

				// Create wrapper around image
				const wrapper = document.createElement('span');
				wrapper.className = 'blog-img-wrapper';
				wrapper.style.cssText = 'position: relative; display: inline-block;';
				img.parentNode.insertBefore(wrapper, img);
				wrapper.appendChild(img);

				const btn = document.createElement('button');
				btn.className = 'blog-expand-btn';
				btn.setAttribute('aria-label', 'Enlarge image');
				btn.innerHTML = expandIcon;
				wrapper.appendChild(btn);

				img.addEventListener('click', (e) => {
					e.preventDefault();
					openLightbox(img.src, img.alt);
				});

				btn.addEventListener('click', (e) => {
					e.preventDefault();
					e.stopPropagation();
					openLightbox(img.src, img.alt);
				});
			});

			closeBtn?.addEventListener('click', closeLightbox);
			lightbox.addEventListener('click', (e) => {
				if (e.target === lightbox || e.target === lightboxImg) {
					closeLightbox();
				}
			});

			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && lightbox.classList.contains('active')) {
					closeLightbox();
				}
			});
		}

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initBlogLightbox);
		} else {
			initBlogLightbox();
		}
	})();
</script>
